<html>

<head>

</head>

<body>
    <svg id="graph"></svg>

    <script src='assets/js/inpage-log.js'></script>
    <script src='https://d3js.org/d3.v5.min.js'></script>
    <script>
        window.onload = function () {
            'use strict';
            // - - - - - - - - - -
            let
                canvas = {},
                fileName = 'assets/data/petits_miserables.json',
                newData = {};

            // log.level = 'default';

            newData.nodes = [{
                "id": "Michael",
                "group": 1
            }];
            newData.links = [{
                "source": "Michael",
                "target": "Andrea",
                "value": 18
            }, {
                "source": "Michael",
                "target": "Laurin",
                "value": 18
            }, {
                "source": "Michael",
                "target": "Mathis",
                "value": 18
            }, {
                "source": "Andrea",
                "target": "Michael",
                "value": 18
            }, {
                "source": "Laurin",
                "target": "Michael",
                "value": 18
            }, {
                "source": "Mathis",
                "target": "Michael",
                "value": 18
            }]

            var color = d3.scaleOrdinal(d3.schemeCategory10);

            function graphFromData(dataFile) {
                // - - - - - - - - - -
                d3.json(dataFile).then(function (graph) {
                    // - - - - -
                    log('success', 'data loaded.')
                    // - - - - -

                    let label, simulationLabels, simulationNodes, adjlist, nodes, links;

                    // ! returns label.links, label.nodes
                    label = setLabelData(label);
                    setSimulation();

                    // addNewData(newData, graph);
                    document.querySelector('svg').addEventListener('click', restartSimulation);

                    function setSimulation() {

                        simulationLabels = d3.forceSimulation(label.nodes) // ! data
                            .force("charge", d3.forceManyBody().strength(-50))
                            .force("link", d3.forceLink(label.links).distance(0).strength(2));

                        // ! uses graph.nodes, graph.links
                        simulationNodes = d3.forceSimulation(graph.nodes) // ! data
                            .force("charge", d3
                                .forceManyBody()
                                .strength(-3000))
                            .force("center", d3.forceCenter(canvas.width / 2, canvas.height / 2))
                            .force("x", d3
                                .forceX(canvas.width / 2)
                                .strength(1))
                            .force("y", d3
                                .forceY(canvas.height / 2)
                                .strength(1))
                            .force("link", d3
                                .forceLink(graph.links)
                                .id(function (d) {
                                    return d.id;
                                })
                                .distance(50)
                                .strength(1))
                            .on("tick", ticked);
                    }


                    function restartSimulation() {
                        try {
                            log('default', 'restartSimulation')

                            addNewData(newData, graph);

                            nodes = simulationNodes.nodes;
                            // links = simulationNodes.links;

                            node = node.selectAll('.node');
                            
                            node = node.append("g")
                                .attr("class", "nodes")
                                .selectAll("g")
                                // ! - - - - -
                                .data(graph.nodes)
                                // ! - - - - -
                                .enter()
                                .append("circle")
                                .attr('r', 10);
                            // @see https://github.com/d3/d3-force/issues/32
                            // simulation.force('link').links(links);
                            // before line .force('link', d3.forceLink(links).id(function(d) { return d.id; })
                            node.exit().remove()

                            simulationNodes.restartSimulation();

                            log('success', 'restartSimulation')
                        } catch (error) {
                            log('error', 'in restartSimulation', error.message)
                        }
                    }

                    function addNewData(newData, graph) {
                        try {
                            log('default', 'addNewData');

                            for (let i = 0; i < newData.nodes.length; i += 1) {
                                graph.nodes.push(newData.nodes[i]);
                            }
                            for (let i = 0; i < newData.links.length; i += 1) {
                                graph.links.push(newData.links[i]);
                            }

                            log('success', 'in addNewData');
                        } catch (error) {
                            log('error', 'in addNewData', error.message);
                        }
                    }


                    adjlist = [];

                    graph.links.forEach(function (d) {
                        adjlist[d.source.index + "-" + d.target.index] = true;
                        adjlist[d.target.index + "-" + d.source.index] = true;
                    });

                    var linksBySource = aggregateLinksBySource(graph.links);
                    var linksCount = aggregateLinksCount(graph.links);

                    var svg = d3.select("#graph").attr("width", canvas.width).attr("height", canvas.height);
                    var container = svg.append("g");

                    svg.call(
                        d3.zoom()
                        .scaleExtent([.1, 4])
                        .on("zoom", function () {
                            container.attr("transform", d3.event.transform);
                        })
                    );

                    // Build links
                    try {
                        var link = container
                            .append("g")
                            .attr("class", "links")
                            .selectAll("line")
                            .data(graph.links)
                            .enter()
                            .append("line")
                            .attr("stroke", "#aaa")
                            .attr("stroke-width", "1px");
                        log('success', 'for set link in container')
                    } catch (error) {
                        log('error', 'in set link in container', error.message)
                    }

                    // Build Nodes
                    try {
                        var node = container
                            .append("g")
                            .attr("class", "nodes")
                            .selectAll("g")
                            .data(graph.nodes)
                            .enter()
                            .append("circle")
                            .attr("r", function (d, i) {
                                return linksBySource[d] || 7;
                            })
                            .attr("fill", function (d) {
                                return color(d.group);
                            })
                        log('success', 'for set node in container')
                    } catch (error) {
                        log('error', 'in set node in container', error.message)
                    }

                    node.on("mouseover", focus).on("mouseout", unfocus);

                    try {
                        node.call(
                            d3.drag()
                            .on("start", dragstarted)
                            .on("drag", dragged)
                            .on("end", dragended)
                        );
                        log('success', 'for node.call()')
                    } catch (error) {
                        log('error', 'in node.call()', error.message)
                    }

                    try {
                        var labelNode = container.append("g").attr("class", "labelNodes")
                            .selectAll("text")
                            .data(label.nodes)
                            .enter()
                            .append("text")
                            .text(function (d, i) {
                                return i % 2 == 0 ? "" : d.node.id;
                            })
                            .style("fill", "#555")
                            .style("font-family", "Arial")
                            .style("font-size", 12)
                            .style("pointer-events", "none"); // to prevent mouseover/drag capture
                        log('success', 'for setting labelNode')
                    } catch (error) {
                        log('error', 'in setting labelNode', error.message)
                    }

                    node.on("mouseover", focus).on("mouseout", unfocus);

                    // - - - - - - - - - -
                    // Local functions
                    // - - - - - - - - - -
                    function setLabelData() {
                        try {
                            let label = {
                                'nodes': [],
                                'links': []
                            }
                            graph.nodes.forEach(function (d, i) {
                                label.nodes.push({
                                    node: d
                                });
                                label.nodes.push({
                                    node: d
                                });
                                label.links.push({
                                    source: i * 2,
                                    target: i * 2 + 1
                                });
                            });

                            log('success', 'for graphData')

                            return label;
                        } catch (error) {
                            log('error', 'in graphData', error.message)
                            return null;
                        }
                    }

                    function ticked() {
                        try {
                            node.call(updateNode);
                            link.call(updateLink);

                            simulationLabels.alphaTarget(0.3).restart();
                            labelNode.each(function (d, i) {
                                if (i % 2 == 0) {
                                    d.x = d.node.x;
                                    d.y = d.node.y;
                                } else {
                                    var b = this.getBBox();

                                    var diffX = d.x - d.node.x;
                                    var diffY = d.y - d.node.y;

                                    var dist = Math.sqrt(diffX * diffX + diffY * diffY);

                                    var shiftX = b.width * (diffX - dist) / (dist * 2);
                                    shiftX = Math.max(-b.width, Math.min(0, shiftX));
                                    var shiftY = 16;
                                    this.setAttribute("transform", "translate(" + shiftX + "," +
                                        shiftY +
                                        ")");
                                }
                            });
                            labelNode.call(updateNode);
                            log('success', 'for ticked')
                        } catch (error) {
                            log('error', 'in ticked', error.message)
                        }

                    }

                    function focus(d) {
                        try {
                            var index = d3.select(d3.event.target).datum().index;
                            node.style("opacity", function (o) {
                                return neigh(index, o.index) ? 1 : 0.1;
                            });
                            labelNode.attr("display", function (o) {
                                return neigh(index, o.node.index) ? "block" : "none";
                            });
                            link.style("opacity", function (o) {
                                return o.source.index == index || o.target.index == index ? 1 : 0.1;
                            });
                            log('success', 'for focus')
                        } catch (error) {
                            log('error', 'in focus', error.message)
                        }

                    }

                    function unfocus() {
                        try {
                            labelNode.attr("display", "block");
                            node.style("opacity", 1);
                            link.style("opacity", 1);
                            log('success', 'for unfocus')
                        } catch (error) {
                            log('error', 'in unfocus', error.message)
                        }
                    }

                    function dragstarted(d) {
                        try {
                            d3.event.sourceEvent.stopPropagation();
                            if (!d3.event.active) simulationNodes.alphaTarget(0.3).restart();
                            d.fx = d.x;
                            d.fy = d.y;
                            log('success', 'for dragstarted')
                        } catch (error) {
                            log('error', 'in dragstarted', error.message)
                        }

                    }

                    function dragged(d) {
                        try {
                            d.fx = d3.event.x;
                            d.fy = d3.event.y;
                            log('success', 'for dragged')
                        } catch (error) {
                            log('error', 'in dragged', error.message)
                        }

                    }

                    function dragended(d) {
                        try {
                            if (!d3.event.active) simulationNodes.alphaTarget(0);
                            d.fx = null;
                            d.fy = null;
                            log('success', 'for dragend')
                        } catch (error) {
                            log('error', 'in dragend', error.message)
                        }

                    }

                    function neigh(a, b) {
                        return a == b || adjlist[a + "-" + b];
                    }
                    // - - - - - - - - - -


                }); // d3.json
                // - - - - - - - - - -
            }

            // - - - - - - - - - -
            // Global functions
            // - - - - - - - - - -
            function setCanvas() {
                try {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                } catch (error) {
                    log('error', 'setting canvas', error.message)
                }
            }

            function updateLink(link) {
                try {
                    link.attr("x1", function (d) {
                            return fixna(d.source.x);
                        })
                        .attr("y1", function (d) {
                            return fixna(d.source.y);
                        })
                        .attr("x2", function (d) {
                            return fixna(d.target.x);
                        })
                        .attr("y2", function (d) {
                            return fixna(d.target.y);
                        });

                    log('success', 'for updateLink')
                } catch (error) {
                    log('error', 'in updateLink', error.message)
                }
            }

            function fixna(x) {
                if (isFinite(x)) return x;
                return 0;
            }

            function updateNode(node) {
                node.attr("transform", function (d) {
                    return "translate(" + fixna(d.x) + "," + fixna(d.y) + ")";
                });
            }

            function aggregateLinksBySource(links) {
                try {
                    let linksBySource = d3.nest()
                        .key(function (d) {
                            return d.source;
                        })
                        .entries(links);
                    return linksBySource; // ! as array
                } catch (error) {
                    log('error', 'in aggregateLinksBySource', error.message);
                }
            }

            function aggregateLinksCount(links) {
                try {
                    let linksCount = d3.nest()
                        .key(function (d) {
                            return d.source;
                        })
                        .rollup(function (v) {
                            return v.length;
                        })
                        .object(links); // ! as object

                    console.dir(linksCount);

                    return linksCount;
                } catch (error) {
                    log('error', 'in aggregateCount', error.message);
                }
                // - - - - - - - - - -
            }

            // - - - - - - - - - -
            function main() {
                setCanvas();
                graphFromData(fileName);
            }

            function init() {
                main();
            }
            // - - - - - - - - - -
            init();
            // - - - - - - - - - -

        }
    </script>
</body>

</html>