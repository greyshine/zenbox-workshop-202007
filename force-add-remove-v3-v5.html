<!DOCTYPE html>
<meta charset="utf-8">
<style>
    html {
        background-color: black;
    }

    svg {
        background-color: white;
    }

    rect {
        fill: none;
        pointer-events: all;
    }

    .node {
        fill: #000;
    }

    .cursor {
        fill: none;
        stroke: brown;
        pointer-events: none;
    }

    .link {
        stroke: #999;
    }
</style>

<body>
    <script>
        let version = 5;
        let loader = 'document.write("<' + 'script src=\\"https://d3js.org/d3.v' + version + '.min.js\\"></' +
            'script>' +
            '");';
        eval(loader);
    </script>
    <script>
        !(function () {
            'use strict';
            // - - - - - - - - - -
            // 1. Global declaration
            // - - - - - - - - - -
            let
                fill, simulation, svg, nodes, links, node, link, cursor,
                i = false,
                canvas = {},
                myNodes = [{}],
                myLinks = [{}];

            canvas = {
                width: 480,
                height: 500
            };

            // - - - - - - - - - -
            // 2. Functions
            // - - - - - - - - - -
            // 2.1. Eventhandler functions
            // - - - - - - - - - -
            function onCanvasMousemove() {
                cursor
                    .attr("transform", "translate(" + d3.mouse(this) + ")");
            }

            function onCanvasMousedown() {
                let point = d3.mouse(this),
                    node = {
                        x: point[0],
                        y: point[1]
                    },
                    n = nodes.push(node);

                // add links to any nearby nodes
                nodes
                    .forEach(function (target) {
                        let x = target.x - node.x,
                            y = target.y - node.y;
                        if (Math.sqrt(x * x + y * y) < 30) {
                            links.push({
                                source: node,
                                target: target
                            });
                        }
                    });
                restartSimulation();
            }

            function onNodeMousedown(d, i) {
                nodes.splice(i, 1);
                links = links.filter(function (l) {
                    return l.source !==
                        d && l.target !== d;
                });
                d3.event.stopPropagation();
                restartSimulation();
            }

            function onTicked() {
                link
                    .attr("x1", function (d) {
                        return d.source.x;
                    }).attr("y1", function (d) {
                        return d.source.y;
                    })
                    .attr("x2", function (d) {
                        return d.target.x;
                    }).attr("y2", function (d) {
                        return d.target.y;
                    });

                node
                    .attr("cx", function (d) {
                        if (i === false) {
                            console.log(typeof node);
                            console.log(typeof d);
                            i = true;
                        }
                        return d.x;
                    }).attr("cy", function (d) {
                        return d.y;
                    });
            }

            function setSvg() {
                svg = d3.select("body")
                    .append("svg")
                    .attr("width", canvas.width)
                    .attr("height", canvas.height)
                    .on("mousemove", onCanvasMousemove)
                    .on("mousedown", onCanvasMousedown);

                svg.append("rect")
                    .attr("width", canvas.width)
                    .attr("height", canvas.height);
            }
            // - - - - - - - - - - 
            // 2.2 Setter functions 
            // - - - - - - - - - - 
            function setColorScheme() {
                switch (version) {
                    case 3:
                        fill = d3.scale.category20();
                        break;
                    case 5:
                        d3.scaleOrdinal(d3.schemeCategory10);
                        break;
                }
            }

            function setSimulation() {
                // Create the force direction graph
                switch (version) {
                    case 3:
                        simulation = d3.layout
                            .force()
                            .size([canvas.width, canvas.height])
                            .nodes(
                                myNodes
                            ) // initialize with a single node 
                            .linkDistance(30)
                            .charge(-60)
                            .on("tick", onTicked);

                        links = simulation.links();
                        nodes = simulation.nodes();
                        break;
                    case 4:
                    case 5:
                        simulation = d3.forceSimulation()
                            .nodes([{}])
                            .force('link', d3.forceLink().distance(30))
                            .force('charge',
                                d3.forceManyBody()
                                .strength(-60))
                            .force('center', d3.forceCenter(canvas.width / 2, canvas.height / 2))
                            .on('tick', onTicked);

                        nodes = simulation.nodes();
                        links = []; // simulation.links(),
                        break;
                }


                node = svg.selectAll(".node");
                link = svg.selectAll(".link");

                restartSimulation();
            }

            function setCursor() {
                // create the cursor 
                cursor = svg.append("circle").attr("r", 30)
                    .attr("transform", "translate(-100,-100)")
                    .attr("class", "cursor");
            }

            function restartSimulation() {
                node = node.data(nodes);

                node.enter()
                    .insert("circle", ".cursor")
                    .attr("class", "node")
                    .attr("r", 5)
                    .on("mousedown", onNodeMousedown);

                node.exit()
                    .remove();

                link = link.data(links);

                link.enter()
                    .insert("line", ".node")
                    .attr("class", "link");

                link.exit()
                    .remove();

                switch (version) {
                    case
                    3:
                        simulation.start();
                        break;
                    case 5:
                        simulation.restart();
                        break;
                }
            }
            // - - - - - - - - - - 
            // 2.3 Control functions 
            // - - - - - - - - - - 
            function main() {
                setSvg();
                setSimulation();
                setCursor();
                setColorScheme();
            }

            function init() {
                main();
            };
            // - - - - - - - - - - 
            // 3. Main control 
            // - - - - - - - - - -
            window.addEventListener('load', init);
            // - - - - - - - - - - 
        }())
    </script>