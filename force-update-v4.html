<!DOCTYPE html>
<meta charset="utf-8">
<style>
    html {
        background-color: black;
    }

    html,
    html * {
        box-sizing: border-box;
    }

    body {
        padding: 0;
        margin: 0;
    }

    svg {
        background-color: hsla(0, 0%, 100%, 0.1);
    }

    text {
        font-family: monospace;
        fill: white;
    }

    .link {
        /* stroke: #c1c1c1; */
        /* stroke-width: 2px; */
        pointer-events: all;
    }

    .node {
        opacity: 0.8;
    }

    .link {
        opacity: 0.4;
    }

    .node circle {
        pointer-events: all;
    }

    path {
        fill: none;
    }

    div.tooltip {
        font-family: Menlo, monospace;
        position: absolute;
        background-color: white;
        max-width: 200px;
        height: auto;
        padding: 0.25rem;
        border-style: solid;
        border-radius: 4px;
        border-width: 1px;
        box-shadow: 3px 3px 10px rgba(0, 0, 0, .5);
        pointer-events: none;
    }

    div.option {
        display: none;
        position: absolute;
        left: 0;
        top: 0;
    }

    output {
        display: block;
        position: absolute;
        left: 1rem;
        top: 1rem;
        color: hsla(0, 0%, 100%, 0.4);
        font-family: Menlo, monospace;
        font-size: 0.8rem;
        line-height: 1.5;
    }
</style>

<body>
    <output id="log"></output>
    <div class="option">
        <input name="updateButton" type="button" value="Update" onclick="updateData()" />
    </div>
    <div class="option">
        <input name="resetButton" type="button" value="Reset" onclick="resetData()" />
    </div>
</body>
<script src="libs/d3/d3.v4.min.js"></script>
<script src="libs/d3/d3-legend/2.24.0/d3-legend.min.js"></script>
<!-- <script src="libs/d3/d3-scale-chromatic.v1.min.js"></script> -->
<script src="libs/lodash.js/3.5.0/lodash.min.js"></script>
<script>
    /** Force Direction Graph
     *
     *  @desc written in d3.v4
     *        - nodes are updating, see updateData(), resetData()
     *        - nodes can be fixed by a click
     *        - fixed nodes can be released by doubleclick
     *
     * @package D3 Datavisualization
     * @module force_directed_graph
     * @author Michael <michael.reichart@gfu.net>
     * @version v1.0.0
     * @since 2019-12-22
     * @see i.e. inspired by Alejandro Suarez {https://bl.ocks.org/almsuarez/295c4ceb007e85e311b09208b342c444}
     * @license MIT {https://opensource.org/licenses/MIT}
     * @copyright (c) 2019 Michael Reichart, Cologne
     */

    !(function () {
        'use strict';
        // - - - - - - - - - -
        // Global declarations
        // - - - - - - - - - -
        let
            canvas,
            colorScale,
            color,
            currNodes,
            currLinks,

            dataFrame,
            dataLinksCount,
            dataLinksBySource,

            legendSequential,
            link,
            linkedByIndex = {},

            maxSame,
            messages = ['> ready ...'],

            node,

            same,
            sameAll,
            sameAlt,
            sequentialScale,
            simulation,
            svg,

            temp = [],
            tooltip;

        // - - - - - - - - - -
        function loadData() {
            d3.json("assets/data/miserables.json", function (error, dataFrame) {
                if (error) throw error;

                setCurrentData(dataFrame);

                aggregate();

                setLinksStatistics(currLinks);
                setMaxSame(currLinks);

                setSimulation();

                drawLinks()

                addNodeBehaviour();
                drawNodes();

                setUpdateIntervals();
            });
        }

        // - - - - - - - - - -
        // Event handler
        // - - - - - - - - - -
        function onDragstarted(d) {
            if (!d3.event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function onDragged(d) {
            d.fx = d3.event.x;
            d.fy = d3.event.y;
        }

        function onDragEnded(d) {
            if (!d3.event.active) simulation.alphaTarget(0);
            //d.fx = null;
            //d.fy = null;
        }

        function onReleaseNode(d) {
            d.fx = null;
            d.fy = null;
        }

        function tooltip_onMouseOut() {
            tooltip
                .transition()
                .duration(100)
                .style("opacity", 0);
        }

        function onMouseMove() {
            tooltip
                .style("left", (d3.event.pageX) + "px")
                .style("top", (d3.event.pageY + 10) + "px");
        }

        function tooltip_onMouseOver(d, i) {
            tooltip
                .transition()
                .duration(300)
                .style("opacity", .8);

            tooltip
                .html(d.id + "<br/>group:" + d.group)
                .style("left", (d3.event.pageX) + "px")
                .style("top", (d3.event.pageY + 10) + "px");
        }

        function fade_onMouseOver() {
            fade(0.1);
        }

        function fade_onMouseOut() {
            fade(1);
        }

        // - - - - - - - - - -
        // Setter
        // - - - - - - - - - -
        function setCanvas() {
            canvas = {
                width: window.outerWidth,
                height: window.outerHeight
            }
        }

        function setSvg() {
            svg = d3.select('body')
                .append('svg')
                .attr('width', canvas.width)
                .attr('height', canvas.height)
        }

        function setLegend() {

            let x, y, w, h, c, r, t, p;

            w = canvas.width / 2;
            h = 25;
            c = 1;
            p = 16;
            t = (0 - canvas.height);
            r = (canvas.width - w);

            sequentialScale = d3.scaleOrdinal(colorScale)
                .domain(['Myriel',
                    'Napoleon',
                    'Mlle.Baptistine',
                    'Mme.Magloire',
                    'CountessdeLo',
                    'Geborand',
                    'Champtercier',
                    'Cravatte',
                    'Count',
                    'OldMan',
                    'Labarre',
                    'Valjean',
                    'Marguerite',
                    'Mme.deR',
                    'Isabeau',
                    'Gervais',
                    'Tholomyes',
                    'Listolier',
                    'Fameuil',
                    'Blacheville',
                    'Favourite',
                    'Dahlia',
                    'Zephine',
                    'Fantine',
                    'Mme.Thenardier',
                    'Thenardier',
                    'Cosette',
                    'Javert',
                    'Fauchelevent',
                    'Bamatabois',
                    'Perpetue',
                    'Simplice',
                    'Scaufflaire',
                    'Woman1',
                    'Judge',
                    'Champmathieu',
                    'Brevet',
                    'Chenildieu',
                    'Cochepaille',
                    'Pontmercy',
                    'Boulatruelle',
                    'Eponine',
                    'Anzelma',
                    'Woman2',
                    'MotherInnocent',
                    'Gribier',
                    'Jondrette',
                    'Mme.Burgon',
                    'Gavroche',
                    'Gillenormand',
                    'Magnon',
                    'Mlle.Gillenormand',
                    'Mme.Pontmercy',
                    'Mlle.Vaubois',
                    'Lt.Gillenormand',
                    'Marius',
                    'BaronessT',
                    'Mabeuf',
                    'Enjolras',
                    'Combeferre',
                    'Prouvaire',
                    'Feuilly',
                    'Courfeyrac',
                    'Bahorel',
                    'Bossuet',
                    'Joly',
                    'Grantaire',
                    'MotherPlutarch',
                    'Gueulemer',
                    'Babet',
                    'Claquesous',
                    'Montparnasse',
                    'Toussaint',
                    'Child1',
                    'Child2',
                    'Brujon',
                    'Mme.Hucheloup'
                ]);

            svg.append("g")
                .attr("class", "legendSequential")
                .attr("transform", function (d, i) {

                    x = p + (r * c);
                    y = p + (t + (i * h));
                    log(x, y);
                    // if (y > canvas.height) {
                    //     c += 1;
                    // }

                    if (typeof x === 'number' && typeof y == 'number')
                        return "translate(" + x + "," + y + ")"
                });

            legendSequential = d3.legendColor()
                .shapeWidth(30)
                .cells(11)
                .orient("vertical")
                .title("Link legend:")
                .titleWidth(100)
                .scale(sequentialScale)

            svg.select(".legendSequential")
                .call(legendSequential);
        }

        function setColorScale() {
            colorScale = d3.schemeCategory20;
        }

        function setColor() {
            color = d3.scaleOrdinal(colorScale)
                .domain(['Am', 'An', 'Ar', 'As', 'Ba', 'Br', 'Ch', 'Cn', 'Cy', 'Gl', 'Gy', 'Li', 'Os',
                    'Pr', 'Vi',
                    'Zy'
                ]);;
        }

        function setTooltip() {
            tooltip = d3.select("body")
                .append("div")
                .classed("tooltip", true)
                .style("opacity", 0);
        }

        function setLinksStatistics(links) {
            currLinks.forEach(function (link) {
                // find other links with same target+source or source+target
                same = _.where(currLinks, {
                    'source': link.source,
                    'target': link.target
                });
                sameAlt = _.where(currLinks, {
                    'source': link.target,
                    'target': link.source
                });
                sameAll = same.concat(sameAlt);

                sameAll.forEach(function (s, i) {
                    s.sameIndex = (i + 1);
                    s.sameTotal = sameAll.length;
                    s.sameTotalHalf = (s.sameTotal / 2);
                    s.sameUneven = ((s.sameTotal % 2) !== 0);
                    s.sameMiddleLink = ((s.sameUneven === true) &&
                        (Math.ceil(s.sameTotalHalf) === s.sameIndex));
                    s.sameLowerHalf = (s.sameIndex <= s.sameTotalHalf);
                    s.sameArcDirection = s.sameLowerHalf ? 0 : 1;
                    s.sameIndexCorrected = s.sameLowerHalf ? s.sameIndex : (s
                        .sameIndex -
                        Math.ceil(
                            s.sameTotalHalf));
                });
            });
        }

        function setCurrentData(data) {
            currNodes = data.nodes;
            currLinks = data.links;
        }

        function setMaxSame() {
            maxSame = _.chain(currLinks)
                .sortBy(function (x) {
                    return x.sameTotal;
                })
                .last()
                .value().sameTotal;

            _.each(currLinks, function (link) {
                link.maxSameHalf = Math.round(maxSame / 2);
            });
        }

        function setSimulation() {
            simulation = d3.forceSimulation()
                .nodes(currNodes)
                .force('link', d3.forceLink().id(d => d.id))
                .force('charge', d3.forceManyBody().strength(5))
                .force('center', d3.forceCenter(canvas.width / 2, canvas.height / 2))
                .force('collide', d3.forceCollide(25))
                .on('tick', ticked);

            simulation.force('link')
                .links(currLinks);
        }

        function setUpdateIntervals() {
            d3.interval(function () {
                updateData();
                restart();
                console.log(currLinks.length)
            }, 4000, d3.now());

            d3.interval(function () {
                resetData();
                restart();
            }, 4000, d3.now() + 2000);
        }

        // - - - - - - - - - -
        // Draw nodes and links
        // - - - - - - - - - -
        function addNodeBehaviour() {
            node = svg.selectAll('.node')
                .data(currNodes)
                .enter()
                .append('g')
                .attr('class', 'node')
                .call(d3.drag()
                    .on("start", onDragstarted)
                    .on("drag", onDragged)
                    .on("end", onDragEnded));;

        }

        function drawNodes() {
            // Draw notes without mouse event listeners
            node
                .append('circle')
                .classed('node', true)
                .attr('r', function (d, i) {
                    let r;
                    if (dataLinksCount && dataLinksCount[d.id]) {
                        r = dataLinksCount[d.id] * 3;
                    } else {
                        r = 0;
                    }
                    if (r < 5) r = 5;
                    return r;
                })
                .attr("style", function (d, i) {
                    return 'fill:' +
                        color(d.group) +
                        ';'
                });

            node
                .on('mouseover.fade', fade_onMouseOver)
                .on('mouseout.fade', fade_onMouseOut)

                .on('mouseover.tooltip', tooltip_onMouseOver)
                .on("mouseout.tooltip", tooltip_onMouseOut)

                .on("mousemove", onMouseMove)
                .on('dblclick', onReleaseNode);

        }

        function addLinkBehaviour(link) {
            //Add mouseover events to links
            link.attr('class', 'link')
                .on('mouseover.fade', fade_onMouseOut)
                .on('mouseout.fade', fade_onMouseOut)

                .on('mouseover.tooltip', tooltip_onMouseOver)
                .on("mouseout.tooltip", tooltip_onMouseOut)

                .on("mousemove", onMouseMove);
        }

        function drawLinks() {
            link = svg.selectAll('.link')
                .data(currLinks)
                .enter()
                .append('path')
                .classed('link', true)
                .attr('style', function (d, i) {
                    return 'stroke:' +
                        color(d.value) +
                        ';' +
                        'stroke-width:' +
                        (Math.sqrt(d.value) * 2) + ';';
                });

            addLinkBehaviour(link);
        }

        // - - - - - - - - - -
        // Update and reset Data
        // - - - - - - - - - -
        function updateData() {
            temp[0] = currLinks.pop();
            temp[1] = currLinks.pop();
            temp[2] = currLinks.pop();
        }

        function resetData() {
            currLinks.push(temp[0]);
            currLinks.push(temp[1]);
            currLinks.push(temp[2]);
        }

        function aggregate() {
            // - - - - - - - - - -
            // Aggregate data
            // - - - - - - - - - -
            // links by source
            // ! .entries() builds an array!
            dataLinksBySource = d3.nest()
                .key(function (d, i) {
                    return d.source;
                })
                .entries(currLinks);
            // - - - - -
            // console.log(dataLinksBySource);
            // - - - - -

            // count links per name
            // ! .object() builds an object!

            dataLinksCount = d3.nest()
                .key(function (d, i) {
                    return d.source;
                })
                .rollup(function (v) {
                    return v.length;
                })
                .object(currLinks);
            // - - - - -
            // console.log(dataLinksCount);
            // - - - - - - - - - -
        }

        // - - - - - - - - - -
        // Simulation
        // - - - - - - - - - -
        function ticked() {
            //     link
            //       .attr('x1', d => d.source.x)
            //       .attr('y1', d => d.source.y)
            //       .attr('x2', d => d.target.x)
            //       .attr('y2', d => d.target.y);
            link.attr("d", linkArc)
            node.attr('transform', d => `translate(${d.x},${d.y})`);
        }

        function restart() {

            link = link.data(currLinks);

            link.exit().transition()
                .attr("stroke-opacity", 0)
                // .attrTween("d", linkArc)
                .remove()
                .attrTween("x1", function (d) {
                    return function () {
                        return d.source.x;
                    };
                })
                .attrTween("x2", function (d) {
                    return function () {
                        return d.target.x;
                    };
                })
                .attrTween("y1", function (d) {
                    return function () {
                        return d.source.y;
                    };
                })
                .attrTween("y2", function (d) {
                    return function () {
                        return d.target.y;
                    };
                })


            link = link.enter().append('path')
                .call(function (link) {
                    link.transition().attr("stroke-opacity", 1);
                })
                .call(function (link) {
                    link.transition().attr("d", linkArc)
                })
                .call(function (link) {
                    link.transition().attr('stroke', function (d) {
                        return color(d.T);
                    })
                })
                .merge(link);

            simulation.nodes(currNodes);
            simulation.force("link").links(currLinks);
            simulation.alpha(1).restart();

        }

        // - - - - - - - - - -
        // Other
        // - - - - - - - - - -
        function linkArc(d) {
            var dx = (d.target.x - d.source.x),
                dy = (d.target.y - d.source.y),
                dr = Math.sqrt(dx * dx + dy * dy),
                unevenCorrection = (d.sameUneven ? 0 : 0.5);
            // curvature term defines how tight the arcs are (lower number = tigher curve)
            var curvature = 2,
                arc = (1.0 / curvature) * ((dr * d.maxSameHalf) / (d.sameIndexCorrected -
                    unevenCorrection));

            //console.log(d.maxSameHalf)
            //d.maxSameHalf always showing zero...
            if (d.sameMiddleLink) {
                arc = 0;
            }

            return "M" + d.source.x + "," + d.source.y + "A" + arc + "," + arc + " 0 0," + d
                .sameArcDirection +
                " " + d.target.x + "," + d.target.y;
        }

        function isConnected(a, b) {
            return linkedByIndex[`${a.index},${b.index}`] || linkedByIndex[`${b.index},${a.index}`] || a
                .index === b.index;
        }

        function fade(opacity) {
            return d => {
                node.style('stroke-opacity', function (o) {
                    const thisOpacity = isConnected(d, o) ? 1 : opacity;
                    this.setAttribute('fill-opacity', thisOpacity);
                    return thisOpacity;
                });

                link.style('stroke-opacity', o => (o.source === d || o.target === d ? 1 : opacity));

            };
        }

        /** In-page logging
         * @desc uses an output element to log
         *       strings within the svg graph
         * @param {any} _arguments to handle one or more values
         * @returns none
         */
        function log() {
            let string = '';

            for (let i = 0; i < arguments.length; i += 1) {
                string += arguments[i] + ', ';
            }
            string = string.substring(0, string.length - 2);
            messages.push(string);

            if (messages.length > 8) messages.shift();

            for (let i = 0; i < messages.length; i += 1) {
                document.querySelector('#log').innerHTML += messages[i] + '<br />&gt; ';
            }

        }
        // - - - - - - - - - -
        function init() {
            setCanvas();
            setSvg();
            setColorScale();
            setColor();
            setTooltip();
            setLegend();
            loadData();
        }

        function main() {
            init();
        }

        // - - - - - - - - - -
        // Main control
        // - - - - - - - - - -
        window.addEventListener('load', init);
        // - - - - - - - - - -
    }());
</script>