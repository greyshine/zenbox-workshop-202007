<!-- thorsten.gomann@generali.com -->
<!DOCTYPE html>
<meta charset="utf-8">
<style>
    rect {
        fill: none;
        pointer-events: all;
    }

    .node {
        fill: #000;
    }

    .cursor {
        fill: none;
        stroke: brown;
        pointer-events: none;
    }

    .link {
        stroke: #999;
    }
</style>

<body>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script>
        var i = false,
            width = 960,
            height = 500;

        var fill = d3.scaleOrdinal(d3.schemeCategory10);

        simulation = d3.forceSimulation()
            // .force('size', forceSize([width, height]))
            .nodes([{}]) // initialize with a single node
            .force('link', d3.forceLink().distance(30))
            .force('charge', d3.forceManyBody().strength(-60))
            //.force('center', d3.forceCenter(width / 2, height / 2))
            .on('tick', tick);

        var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height)
            .on("mousemove", mousemove)
            .on("mousedown", mousedownCanvas);

        svg.append("rect")
            .attr("width", width)
            .attr("height", height);

        var
            nodes = simulation.nodes(),
            links = [], // simulation.links(),
            node = svg.selectAll(".node"),
            link = svg.selectAll(".link");

        console.log(node)
        console.log(link)

        var cursor = svg.append("circle")
            .attr("r", 30)
            .attr("transform", "translate(-100,-100)")
            .attr("class", "cursor");

        restart();

        function mousemove() {
            cursor.attr("transform", "translate(" + d3.mouse(this) + ")");
        }

        function mousedownCanvas() {
            var point = d3.mouse(this),
                node = {
                    x: parseInt(point[0]),
                    y: parseInt(point[1])
                },
                n = nodes.push(node);

            // add links to any nearby nodes
            nodes.forEach(function (target) {

                var x = parseInt(target.x) - parseInt(node.x),
                    y = parseInt(target.y) - parseInt(node.y);

                // if (Math.sqrt(x * x + y * y) < 30) {
                links.push({
                    source: node,
                    target: target
                });
                // }
                // console.log(links.length);
                // console.log(links[links.length - 1].source.x);
                // console.log(links[links.length - 1].source.y);
            });

            // console.log(nodes);
            // console.log(links);

            restart();
        }

        function mousedownNode(d, i) {
            nodes.splice(i, 1);

            links = links.filter(function (l) {
                return l.source !== d && l.target !== d;
            });
            d3.event.stopPropagation();

            restart();
        }

        function tick() {
            if (link) {
                link.attr("x1", function (d) {
                        return d.source.x;
                    })
                    .attr("y1", function (d) {
                        return d.source.y;
                    })
                    .attr("x2", function (d) {
                        return d.target.x;
                    })
                    .attr("y2", function (d) {
                        return d.target.y;
                    });
            }
            if (node) {
                node.attr("cx", function (d) {
                        return d.x;
                    })
                    .attr("cy", function (d) {
                        return d.y;
                    });
            }
        }

        function restart() {

            node.exit().remove();

            node = node.data(nodes);

            node.enter()
                .append("circle", ".cursor")
                .attr("class", "node")
                .attr("r", 7)
                .attr('cx', 100)
                .attr('cx', 100)
                .attr('cy', 100)
                .on("mousedown", mousedownNode);

            link.exit().remove();

            link = link.data(links);

            link.enter()
                .append("line", ".node")
                .attr("class", "link");

            simulation.alphaTarget(0.5).restart();
        }
    </script>